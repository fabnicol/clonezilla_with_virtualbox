name: CloneZilla with virtualbox+
on:
  push:

    tags:
      - 'v*' 

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: update repo
        run: sudo apt update 
        
      - name: build
        run: |
          sudo apt install util-linux squashfs-tools curl mkisofs util-linux xorriso xz-utils
          sudo ./build.sh clonezilla.iso clonezilla_with_virtualbox.iso
          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body:  
            The release was automatically created by the Git Actions workflow corresponding to directory .github in the repository.  
            The input of this release is the CloneZilla release liked to in the Readme.   
                          
            **Technical note**   
            The split parameter for archive saved (ocs-sr -i...) has been set to 4096 (MB), so that it exactly matches the new value set for xorriso split_size and there is no risk of a differing split limits (an issue was once noticed experimentally with split_limit set at 2017 for xorriso and an xz archive slightly bigger that 2GB).   

            **Checksums**   
            md5sum $(md5sum ./clonezilla_with_virtualbox.iso)   
            sha1sum $(sha1sum ./clonezilla_with_virtualbox.iso)  
            sha256sum $(sha256sum ./clonezilla_with_virtualbox.iso)  

          draft: false
          prerelease: false
          
      - name: Upload Release Asset
        id: upload-release-asset 
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} 
          asset_path: ./clonezilla_with_virtualbox.iso
          asset_name: clonezilla_with_virtualbox.iso
          asset_content_type: application/octet-stream
